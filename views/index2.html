<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>게시판</title>
    <link rel = "stylesheet" type="text/css" href="/indexcss.css">

</head>
<body>
<h1>게시판</h1>
<table>
    <tr>
        <th>번호</th>
        <th>제목</th>
        <th>작성자</th>
    </tr>
    <div id="content">

    </div>
    <div id = "button">
        <button onclick="getContent()">내용불러오기</button>
    </div>

    <!---

!--->
</table>
<script>
    //const attach = document.getElementById('content');
    let obj;

    function open() {
       //readDoc();
        console.log("new page");
        window.onload = function () {
            let httpRequest;
            if (window.XMLHttpRequest) { //Chrome, Safari..
                httpRequest = new XMLHttpRequest();
            }

            httpRequest.onreadystatechange = function () {
                var local = document.getElementsByTagName("table")[0].getElementsByTagName("tbody")[0];
                local.setAttribute('id', 'root');

                if (httpRequest.readyState === 4) {
                    /* 서버에 대한 요청 응답 처리 상태 : readyState */
                    if (httpRequest.status === 200) {
                        /* 서버 응답 코드 : status */
                        //attach.innerHTML = httpRequest.responseText;
                        obj = JSON.parse(httpRequest.responseText);

                        var elements = document.getElementsByClassName('row');
                        //elements.setAttribute('id', 'elem');
                        while (elements.length > 0) {
                            elements[0].parentNode.removeChild(elements[0]);
                        }

                        for (i = 0; i < obj.length; i++) {

                            var tr = document.createElement("tr");
                            tr.setAttribute('class', 'row');
                            tr.setAttribute('id', obj[i]._id);

                            var td1 = document.createElement("td");
                            td1.appendChild(document.createTextNode(i + 1));
                            var td2 = document.createElement("td");
                            td2.appendChild(document.createTextNode(obj[i].title));
                            var td3 = document.createElement("td");
                            td3.appendChild(document.createTextNode(obj[i].author));

                            tr.appendChild(td1);
                            tr.appendChild(td2);
                            tr.appendChild(td3);

                            console.log(obj[i]);
                            local.appendChild(tr);
                            /*tr.onclick=function(){
                            console.log(this.id);
                           //document.location = '/boards/read:'+this._id;
                          }*/
                            tr.onclick = function () {
                                console.log(this.id);
                                readDoc();
                                sendAjax('/boards/ajax/read/' + this.id);
                            }
                        }
                    }
                }
            }
            httpRequest.open('GET', '/boards/ajax/contentGet', true);
            httpRequest.send();
            //console.log(element);
        }
    }
    open();


    function readDoc() {


        var but = document.getElementById('button');
        but.parentNode.removeChild(but);
        var cell= document.getElementById("root");
        while(cell.hasChildNodes()){
            cell.removeChild(cell.firstChild);
        }
        //console.log(id);

    }
    function sendAjax(url, data){
        var data;
        data = JSON.stringify(data);
        var result;
        var xhr = new XMLHttpRequest();
        xhr.open('POST', url);
        xhr.setRequestHeader('Content-type', "application/json");

        //console.log(xhr.responseText);
        //result = JSON.parse(xhr.responseText);
        xhr.send(data);
        //console.log(result);

        xhr.addEventListener('load', function(){
           result= JSON.parse(xhr.responseText);
           var my_div = null;
           var newDiv =null;

           newDiv = document.createElement("div");
           newDiv.innerHTML = "제목: "+result[0].title + "<br/>" + "내용: "+result[0].contents + "<br/>"
               + "작성자: " + result[0].author;
           my_div = document.getElementById("content");
           document.body.insertBefore(newDiv, my_div);
           //alert(result[0]._id);
            var btn = document.createElement("BUTTON");
            var t = document.createTextNode("확인");
            btn.appendChild(t);
            document.body.appendChild(btn);
            btn.onclick = function(){
                //alert('돌아갈래~');
                //open();
                getContent();
            }
        })
    };

    let getContent = function(){
        let httpRequest;
        if(window.XMLHttpRequest){ //Chrome, Safari..
            httpRequest = new XMLHttpRequest();
        }

        httpRequest.onreadystatechange = function(){
            var local = document.getElementsByTagName("table")[0].getElementsByTagName("tbody")[0];
            local.setAttribute('id', 'root');

            if(httpRequest.readyState === 4) {
                /* 서버에 대한 요청 응답 처리 상태 : readyState */
                if (httpRequest.status === 200) {
                    /* 서버 응답 코드 : status */
                    //attach.innerHTML = httpRequest.responseText;
                    obj = JSON.parse(httpRequest.responseText);

                    var elements = document.getElementsByClassName('row');
                    //elements.setAttribute('id', 'elem');
                    while(elements.length>0){
                        elements[0].parentNode.removeChild(elements[0]);
                    }

                    for ( i = 0; i < obj.length; i++) {

                        var tr = document.createElement("tr");
                        tr.setAttribute('class', 'row');
                        tr.setAttribute('id', obj[i]._id);

                        var td1 = document.createElement("td");
                        td1.appendChild(document.createTextNode(i + 1));
                        var td2 = document.createElement("td");
                        td2.appendChild(document.createTextNode(obj[i].title));
                        var td3 = document.createElement("td");
                        td3.appendChild(document.createTextNode(obj[i].author));

                        tr.appendChild(td1);
                        tr.appendChild(td2);
                        tr.appendChild(td3);

                        console.log(obj[i]);
                        local.appendChild(tr);
                        /*tr.onclick=function(){
                        console.log(this.id);
                       //document.location = '/boards/read:'+this._id;
                      }*/
                        tr.onclick=function(){
                            readDoc(this.id);
                            var but = document.getElementById('button');
                            but.parentNode.removeChild(but);
                        }
                    }

                }
            }

        }
        httpRequest.open('GET', '/boards/ajax/contentGet', true);
        httpRequest.send();


        //console.log(element);
    }

</script>
</body>
</html>